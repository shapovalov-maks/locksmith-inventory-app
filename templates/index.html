<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üîë Locksmith Inventory</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        form { max-width: 400px; margin: auto; }
        input, button, label { width: 100%; margin-top: 10px; padding: 8px; box-sizing: border-box; }
        button[type="button"] { width: auto; display: inline-block; margin-left: 5px; }
        table { border-collapse: collapse; width: 100%; margin-top: 30px; overflow-x: auto; display: block; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; white-space: nowrap; }
        th { background-color: #f2f2f2; }
        .low-stock { color: red; font-weight: bold; }
        #reader, #quick_reader { width: 100%; max-width: 300px; margin: 10px auto; }
        mark { background-color: yellow; font-weight: bold; }
    </style>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
    <h2 style="text-align: center;">üîë Locksmith Inventory</h2>

    <form method="get" action="/" style="max-width: 600px; margin: 0 auto 30px auto;">
        <label>Search Inventory:</label>
        <input type="text" name="search" placeholder="FCC ID, Make, Model, Year" value="{{ request.args.get('search', '') }}">
        <button type="submit">Search</button>
    </form>

    <form action="/add" method="post">
        <label>FCC ID:</label>
        <div style="display: flex; align-items: center;">
            <input type="text" id="fcc_id" name="fcc_id" required>
            <button type="button" onclick="startScanner()">üì∑</button>
        </div>
        <div id="reader"></div>

        <label>Make:</label>
        <input type="text" name="make" required>

        <label>Model:</label>
        <input type="text" name="model" required>

        <label>Year:</label>
        <input type="number" name="year" required>

        <label>Box Slot:</label>
        <input type="text" name="box_slot">

        <label>Quantity:</label>
        <input type="number" name="quantity" min="0">

        <label>Available:</label>
        <input type="checkbox" name="available" checked>

        <label>Comments:</label>
        <input type="text" name="comments">

        <button type="submit">Add New Key</button>
    </form>

    <form action="/quick_add" method="post" style="max-width: 400px; margin: 40px auto;">
        <h4>üì¶ Quick Add (Scan or Type)</h4>
        <label>FCC ID:</label>
        <div style="display: flex;">
            <input type="text" name="fcc_id" id="quick_fcc_id" required>
            <button type="button" onclick="startQuickScanner()">üì∑</button>
        </div>
        <div id="quick_reader"></div>

        <label>Quantity:</label>
        <input type="number" name="quantity" min="1" required>

        <label>Box Slot:</label>
        <input type="text" name="box_slot">

        <button type="submit">Add / Update</button>
    </form>

    <form action="/upload_order" method="post" enctype="multipart/form-data" style="max-width: 400px; margin: 40px auto;">
        <h4>üìÅ Upload Order File</h4>
        <label>Select CSV, Excel or TXT file:</label>
        <input type="file" name="file" accept=".csv,.xlsx,.txt" required>
        <button type="submit">Upload and Import</button>
    </form>

    <h3 style="margin-top: 40px;">All Keys</h3>
    <table>
        <thead>
            <tr>
                <th>FCC ID</th>
                <th>Make</th>
                <th>Model</th>
                <th>Year</th>
                <th>Box Slot</th>
                <th>Quantity</th>
                <th>Available</th>
                <th>Comments</th>
            </tr>
        </thead>
        <tbody>
            {% for key in keys %}
            <tr>
                <td><a href="{{ url_for('key_models', key_id=key.id) }}">
                    {% if search %}{{ key.fcc_id | replace(search, '<mark>' ~ search ~ '</mark>') | safe }}{% else %}{{ key.fcc_id }}{% endif %}
                </a></td>
                <td>{% if search %}{{ key.make | replace(search, '<mark>' ~ search ~ '</mark>') | safe }}{% else %}{{ key.make }}{% endif %}</td>
                <td>{% if search %}{{ key.model | replace(search, '<mark>' ~ search ~ '</mark>') | safe }}{% else %}{{ key.model }}{% endif %}</td>
                <td>{% if search %}{{ key.year | string | replace(search, '<mark>' ~ search ~ '</mark>') | safe }}{% else %}{{ key.year }}{% endif %}</td>
                <td>{{ key.box_slot or '' }}</td>
                <td>
                    {{ key.quantity }}
                    {% if key.quantity|int <= 1 %}<span class="low-stock"> ‚Äî Restock needed!</span>{% endif %}
                </td>
                <td>{% if key.available %}‚úÖ{% else %}‚ùå{% endif %}</td>
                <td>{{ key.comments or '' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
    let scannerRunning = false;
    let html5QrCode;

    function startScanner() {
        const qrRegion = document.getElementById("reader");
        if (!scannerRunning) {
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                qrCodeMessage => {
                    document.getElementById("fcc_id").value = qrCodeMessage;
                    stopScanner();
                }
            ).then(() => { scannerRunning = true; }).catch(err => {
                alert("Camera error: " + err);
            });
        } else {
            stopScanner();
        }
    }

    function stopScanner() {
        if (html5QrCode && scannerRunning) {
            html5QrCode.stop().then(() => {
                html5QrCode.clear();
                scannerRunning = false;
            }).catch(err => {
                console.error("Stop error", err);
            });
        }
    }

    function startQuickScanner() {
        const qrRegion = document.getElementById("quick_reader");
        if (!window.quickQrCode) {
            window.quickQrCode = new Html5Qrcode("quick_reader");
            quickQrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 200 },
                (message) => {
                    document.getElementById("quick_fcc_id").value = message;
                    quickQrCode.stop();
                    quickQrCode.clear();
                }
            );
        }
    }
    </script>
</body>
</html>
