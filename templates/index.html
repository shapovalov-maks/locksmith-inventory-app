<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>üîë Locksmith Inventory</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        form { max-width: 500px; margin: auto; }
        input, select, button, label { width: 100%; margin-top: 10px; padding: 8px; box-sizing: border-box; }
        button[type="button"] { width: auto; display: inline-block; margin-left: 5px; }
        table { border-collapse: collapse; width: 100%; margin-top: 30px; overflow-x: auto; display: block; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; white-space: nowrap; }
        th { background-color: #f2f2f2; }
        .low-stock { color: red; font-weight: bold; }
        #reader { width: 100%; max-width: 300px; margin: 10px auto; }
        mark { background-color: yellow; font-weight: bold; }
    </style>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
    <h2 style="text-align: center;">üîë Locksmith Inventory</h2>

    <form action="/add" method="post">
        <label>Barcode:</label>
        <div style="display: flex; align-items: center;">
            <input type="text" id="barcode" name="barcode" required oninput="autoFillFromKnownCodes()">
            <button type="button" onclick="startScanner()">üì∑</button>
        </div>
        <div id="reader"></div>

        <label>Type:</label>
        <select name="type" id="type">
            <option value="">-- Select Type --</option>
            <option value="fcc">FCC</option>
            <option value="universal">Universal</option>
            <option value="chip">Chip</option>
            <option value="blade">Blade</option>
        </select>

        <label>Make:</label>
        <input type="text" name="make" id="make" placeholder="Auto-filled if known">

        <label>Model:</label>
        <input type="text" name="model" id="model">

        <label>Description:</label>
        <input type="text" name="comments" id="description" placeholder="Auto-filled if known">

        <label>Box Slot:</label>
        <input type="text" name="box_slot" required>

        <label>Quantity:</label>
        <input type="number" name="quantity" min="1" value="1" required>

        <label>Available:</label>
        <input type="checkbox" name="available" checked>

        <button type="submit">Add New Item</button>
    </form>

    <h3 style="margin-top: 40px;">All Inventory</h3>
    <table>
        <thead>
            <tr>
                <th>FCC ID</th>
                <th>Barcode</th>
                <th>Type</th>
                <th>Make</th>
                <th>Model</th>
                <th>Year</th>
                <th>Box Slot</th>
                <th>Quantity</th>
                <th>Available</th>
                <th>Comments</th>
            </tr>
        </thead>
        <tbody>
            {% for key in keys %}
            <tr>
                <td>{{ key.fcc_id }}</td>
                <td>{{ key.barcode }}</td>
                <td>{{ key.type }}</td>
                <td>{{ key.make }}</td>
                <td>{{ key.model }}</td>
                <td>{{ key.year }}</td>
                <td>{{ key.box_slot or '' }}</td>
                <td>
                    {{ key.quantity }}
                    {% if key.quantity <= 1 %}<span class="low-stock"> ‚Äî Restock needed!</span>{% endif %}
                </td>
                <td>{% if key.available %}‚úÖ{% else %}‚ùå{% endif %}</td>
                <td>{{ key.comments or '' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
    let scannerRunning = false;
    let html5QrCode;

    function startScanner() {
        const qrRegion = document.getElementById("reader");
        if (!scannerRunning) {
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                qrCodeMessage => {
                    document.getElementById("barcode").value = qrCodeMessage;
                    autoFillFromKnownCodes();
                    stopScanner();
                }
            ).then(() => { scannerRunning = true; }).catch(err => {
                alert("Camera error: " + err);
            });
        } else {
            stopScanner();
        }
    }

    function stopScanner() {
        if (html5QrCode && scannerRunning) {
            html5QrCode.stop().then(() => {
                html5QrCode.clear();
                scannerRunning = false;
            }).catch(err => {
                console.error("Stop error", err);
            });
        }
    }

    async function autoFillFromKnownCodes() {
        const barcode = document.getElementById("barcode").value;
        if (barcode.length < 4) return;

        const response = await fetch(`/known-codes/api/${barcode}`);
        if (response.ok) {
            const data = await response.json();
            if (data) {
                if (data.type) document.getElementById("type").value = data.type;
                if (data.description) document.getElementById("description").value = data.description;
                if (data.brand) document.getElementById("make").value = data.brand;
            }
        }
    }
    </script>
</body>
</html>
