<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üîë Locksmith Inventory</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f9f9f9; margin: 0; padding: 0; }
    h2 { text-align: center; padding: 20px; font-size: 24px; }
    form { background-color: #fff; max-width: 500px; margin: auto; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
    label { font-weight: 600; margin-top: 12px; display: block; }
    input, select { width: 100%; padding: 10px; margin-top: 6px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
    button { background-color: #007bff; color: #fff; border: none; padding: 12px; margin-top: 20px; width: 100%; border-radius: 6px; font-size: 16px; cursor: pointer; }
    button:hover { background-color: #0056b3; }

    #scanner-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 20px auto;
      display: none;
      overflow: hidden;
      height: 300px;
      border-radius: 8px;
      background-color: #000;
    }

    #interactive.viewport {
      width: 100%;
      height: 100%;
      position: relative;
    }

    #interactive.viewport > canvas, #interactive.viewport > video {
      max-width: 100%;
      width: 100%;
    }

    .drawingBuffer {
      position: absolute;
      top: 0;
      left: 0;
    }

    #scanner-status { text-align: center; margin-top: 10px; color: #666; }
    #scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 10;
    }
    #scanner-loading {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      background: rgba(0,0,0,0.8);
      padding: 10px 20px;
      border-radius: 20px;
      z-index: 20;
    }

    #debug-canvas {
      display: none;
      width: 100%;
      max-width: 500px;
      margin: 10px auto;
      border: 1px solid #ccc;
    }

    #debug-info {
      font-family: monospace;
      font-size: 12px;
      padding: 10px;
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 10px;
      max-height: 150px;
      overflow-y: auto;
      display: none;
    }

    .detected-barcode {
      border: 2px solid #00ff00;
      background: rgba(0, 255, 0, 0.2);
      position: absolute;
      z-index: 20;
    }

    .format-selector {
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #eee;
    }

    .format-selector label {
      font-weight: normal;
      display: inline-block;
      margin-right: 10px;
      margin-top: 5px;
    }

    .format-selector input[type="checkbox"] {
      width: auto;
      margin-right: 5px;
    }

    table { width: 95%; margin: 20px auto; border-collapse: collapse; background-color: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    th { background-color: #007bff; color: #fff; }
    .delete-btn { background-color: #dc3545; color: white; border: none; padding: 6px 10px; font-size: 14px; border-radius: 4px; cursor: pointer; }

    @media (max-width: 768px) {
      #scanner-container {
        height: 250px;
      }
    }
  </style>
</head>
<body>
  <h2>üîë Locksmith Inventory</h2>

  <form method="get" action="/">
    <div style="max-width: 500px; margin: auto; display: flex; gap: 10px; padding: 0 20px 20px;">
      <input type="text" name="search" placeholder="Search..." value="{{ search or '' }}" style="flex: 1; padding: 10px; font-size: 16px;" />
      <button type="submit" style="padding: 10px 20px;">Search</button>
    </div>
  </form>

  <form id="add-form" action="/add" method="post">
    <label for="barcode">Barcode:</label>
    <div style="display: flex; gap: 8px;">
      <input type="text" id="barcode" name="barcode" required oninput="autoFillFromKnownCodes()" />
      <button type="button" onclick="toggleScanner()">Scan</button>
    </div>

    <div id="scanner-container">
      <div id="interactive" class="viewport"></div>
      <div id="scanner-loading">Loading camera...</div>
    </div>
    <div id="scanner-status"></div>

    <div id="debug-info"></div>
    <canvas id="debug-canvas"></canvas>

    <div class="format-selector">
      <h4 style="margin-top: 0;">Barcode Formats:</h4>
      <div style="display: flex; flex-wrap: wrap;">
        <label><input type="checkbox" class="format-checkbox" value="code_128_reader" checked> Code 128</label>
        <label><input type="checkbox" class="format-checkbox" value="ean_reader" checked> EAN</label>
        <label><input type="checkbox" class="format-checkbox" value="ean_8_reader" checked> EAN-8</label>
        <label><input type="checkbox" class="format-checkbox" value="code_39_reader" checked> Code 39</label>
        <label><input type="checkbox" class="format-checkbox" value="code_93_reader" checked> Code 93</label>
        <label><input type="checkbox" class="format-checkbox" value="upc_reader" checked> UPC</label>
        <label><input type="checkbox" class="format-checkbox" value="upc_e_reader" checked> UPC-E</label>
        <label><input type="checkbox" class="format-checkbox" value="i2of5_reader"> Interleaved 2 of 5</label>
        <label><input type="checkbox" class="format-checkbox" value="2of5_reader"> Standard 2 of 5</label>
        <label><input type="checkbox" class="format-checkbox" value="codabar_reader"> Codabar</label>
      </div>
    </div>

    <div style="margin-top: 10px;">
      <label for="debug-mode" style="display: inline-block; font-weight: normal;">
        <input type="checkbox" id="debug-mode" style="width: auto; margin-right: 5px;">
        Debug Mode
      </label>
    </div>

    <label for="type">Type:</label>
    <select name="type" id="type">
      <option value="fcc">FCC</option>
      <option value="universal">Universal</option>
      <option value="chip">Chip</option>
      <option value="blade">Blade</option>
    </select>

    <label for="description">Description:</label>
    <input type="text" name="comments" id="description" placeholder="Auto-filled if known">

    <label for="box_slot">Box Slot:</label>
    <input type="text" name="box_slot" required>

    <label for="quantity">Quantity:</label>
    <input type="number" name="quantity" min="1" value="1" required>

    <label for="available">Available:</label>
    <input type="checkbox" name="available" checked>

    <button type="submit">Add New Item</button>
    <button type="button" onclick="clearForm()" style="background-color: gray; margin-top: 10px;">Clear</button>
  </form>

  {% if keys %}
    <table>
      <thead>
        <tr>
          <th>Barcode</th>
          <th>FCC ID</th>
          <th>Type</th>
          <th>Make</th>
          <th>Model</th>
          <th>Year</th>
          <th>Box</th>
          <th>Qty</th>
          <th>Available</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for key in keys %}
          <tr>
            <td>{{ key.barcode }}</td>
            <td>{{ key.fcc_id or '' }}</td>
            <td>{{ key.type }}</td>
            <td>{{ key.make or '' }}</td>
            <td>{{ key.model or '' }}</td>
            <td>{{ key.year or '' }}</td>
            <td>{{ key.box_slot }}</td>
            <td>{{ key.quantity }}</td>
            <td>{{ '‚úîÔ∏è' if key.available else '‚ùå' }}</td>
            <td>
              <form action="/delete/{{ key.id }}" method="post" onsubmit="return confirm('Are you sure you want to delete this item?');">
                <button class="delete-btn">Delete</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p style="text-align: center; color: #888;">No keys found.</p>
  {% endif %}

  <script>
    let quaggaScanner = null;
    let scanAttempts = 0;
    let previousResults = [];
    const MAX_SCAN_ATTEMPTS = 15;
    const REQUIRED_MATCHES = 3; // Number of matching results required

    function updateScannerStatus(message) {
      const statusEl = document.getElementById("scanner-status");
      if (statusEl) {
        statusEl.textContent = message;
      }
    }

    function debugLog(message) {
      const debugInfo = document.getElementById("debug-info");
      if (debugInfo && document.getElementById("debug-mode").checked) {
        const entry = document.createElement("div");
        entry.textContent = message;
        debugInfo.appendChild(entry);
        debugInfo.scrollTop = debugInfo.scrollHeight;
      }
    }

    // Get selected barcode formats
    function getSelectedFormats() {
      const checkboxes = document.querySelectorAll('.format-checkbox:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    async function toggleScanner() {
      const scannerContainer = document.getElementById("scanner-container");
      const loadingEl = document.getElementById("scanner-loading");
      const debugInfo = document.getElementById("debug-info");
      const debugCanvas = document.getElementById("debug-canvas");

      // If scanner is active, stop it
      if (quaggaScanner) {
        try {
          Quagga.stop();
          quaggaScanner = null;
          scannerContainer.style.display = "none";
          debugInfo.style.display = "none";
          debugCanvas.style.display = "none";
          updateScannerStatus("");
        } catch (e) {
          console.error("Error stopping scanner:", e);
        }
        return;
      }

      // Check if at least one format is selected
      const selectedFormats = getSelectedFormats();
      if (selectedFormats.length === 0) {
        alert("Please select at least one barcode format.");
        return;
      }

      // Show scanner and loading indicator
      scannerContainer.style.display = "block";
      loadingEl.style.display = "block";
      updateScannerStatus("Initializing scanner...");

      // Show debug info if debug mode is checked
      if (document.getElementById("debug-mode").checked) {
        debugInfo.style.display = "block";
        debugCanvas.style.display = "block";
        debugInfo.innerHTML = "";
      }

      // Reset scan attempts and previous results
      scanAttempts = 0;
      previousResults = [];

      try {
        await initQuagga();
        loadingEl.style.display = "none";
        updateScannerStatus("Camera ready. Point at a barcode to scan.");
      } catch (error) {
        console.error("Failed to initialize scanner:", error);
        updateScannerStatus("Failed to start scanner: " + error.message);
        scannerContainer.style.display = "none";
        loadingEl.style.display = "none";
        alert("Failed to initialize the barcode scanner: " + error.message);
      }
    }

    function initQuagga() {
      return new Promise((resolve, reject) => {
        const selectedFormats = getSelectedFormats();
        debugLog(`Initializing scanner with formats: ${selectedFormats.join(', ')}`);

        Quagga.init({
          inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector("#interactive"),
            constraints: {
              facingMode: "environment", // Use the back camera
              width: { min: 640 },
              height: { min: 480 },
              aspectRatio: { min: 1, max: 2 }
            },
            area: { // Define a slightly larger scanning area
              top: "15%",
              right: "10%",
              left: "10%",
              bottom: "15%"
            }
          },
          locator: {
            patchSize: "medium",
            halfSample: true
          },
          numOfWorkers: 2,
          frequency: 10,
          decoder: {
            readers: selectedFormats.map(format => ({
              format: format,
              config: {}
            })),
            multiple: false
          },
          locate: true
        }, function(err) {
          if (err) {
            reject(err);
            return;
          }

          quaggaScanner = true;

          // Debug visualizer
          if (document.getElementById("debug-mode").checked) {
            Quagga.onProcessed(function(result) {
              var drawingCtx = Quagga.canvas.ctx.overlay,
                  drawingCanvas = Quagga.canvas.dom.overlay;

              if (result) {
                if (result.boxes) {
                  drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                  result.boxes.filter(function (box) {
                      return box !== result.box;
                  }).forEach(function (box) {
                      Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                  });
                }

                if (result.box) {
                  Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                }

                if (result.codeResult && result.codeResult.code) {
                  Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});

                  // Clone debug canvas to our visible debug canvas
                  const debugCanvas = document.getElementById("debug-canvas");
                  const context = debugCanvas.getContext("2d");
                  debugCanvas.width = drawingCanvas.width;
                  debugCanvas.height = drawingCanvas.height;
                  context.drawImage(drawingCanvas, 0, 0);
                }
              }
            });
          }

          Quagga.start();
          resolve();

          // Register callback for successful detection
          Quagga.onDetected(function(result) {
            if (result && result.codeResult) {
              const code = result.codeResult.code;
              const format = result.codeResult.format;
              debugLog(`Detected ${format} code: ${code} (confidence: ${result.codeResult.confidence.toFixed(2)})`);

              // Only consider results with confidence above 0.65
              if (result.codeResult.confidence > 0.65) {
                scanAttempts++;
                previousResults.push(code);

                // Check if we have a consensus (multiple identical results)
                const resultCounts = {};
                let maxCount = 0;
                let mostFrequentCode = null;

                for (const res of previousResults) {
                  resultCounts[res] = (resultCounts[res] || 0) + 1;
                  if (resultCounts[res] > maxCount) {
                    maxCount = resultCounts[res];
                    mostFrequentCode = res;
                  }
                }

                // Update status with current scan attempt info
                updateScannerStatus(`Scanning... (${scanAttempts}/${MAX_SCAN_ATTEMPTS})`);

                // If we have enough matches for a code or reached max attempts
                if (maxCount >= REQUIRED_MATCHES || scanAttempts >= MAX_SCAN_ATTEMPTS) {
                  if (mostFrequentCode) {
                    // We have a reliable result
                    debugLog(`Selected code: ${mostFrequentCode} (detected ${maxCount} times)`);
                    updateScannerStatus(`Barcode detected: ${mostFrequentCode}`);

                    // Fill the barcode input and trigger autofill
                    document.getElementById("barcode").value = mostFrequentCode;
                    autoFillFromKnownCodes();

                    // Stop scanner
                    Quagga.stop();
                    quaggaScanner = null;
                    document.getElementById("scanner-container").style.display = "none";
                    if (!document.getElementById("debug-mode").checked) {
                      document.getElementById("debug-info").style.display = "none";
                      document.getElementById("debug-canvas").style.display = "none";
                    }
                  } else {
                    // No reliable result after max attempts
                    updateScannerStatus("Could not detect a reliable barcode. Please try again.");

                    // Stop scanner
                    Quagga.stop();
                    quaggaScanner = null;
                    document.getElementById("scanner-container").style.display = "none";
                    if (!document.getElementById("debug-mode").checked) {
                      document.getElementById("debug-info").style.display = "none";
                      document.getElementById("debug-canvas").style.display = "none";
                    }
                  }
                }
              }
            }
          });
        });
      });
    }

    async function autoFillFromKnownCodes() {
      const barcode = document.getElementById("barcode").value;
      if (barcode.length < 4) return;
      try {
        const response = await fetch(`/known-codes/api/${barcode}`);
        if (response.ok) {
          const data = await response.json();
          if (data.type) document.getElementById("type").value = data.type;
          if (data.description) document.getElementById("description").value = data.description;
        }
      } catch (err) {
        console.error("Auto-fill error:", err);
      }
    }

    function clearForm() {
      const form = document.getElementById("add-form");
      form.reset();

      // Restore default format checkbox selections
      document.querySelectorAll('.format-checkbox').forEach(checkbox => {
        if (['code_128_reader', 'ean_reader', 'ean_8_reader', 'code_39_reader',
            'code_93_reader', 'upc_reader', 'upc_e_reader'].includes(checkbox.value)) {
          checkbox.checked = true;
        } else {
          checkbox.checked = false;
        }
      });

      document.getElementById("barcode").focus();
    }

    document.getElementById("add-form").addEventListener("submit", function () {
      setTimeout(() => clearForm(), 200);
    });

    // Check if the site is loaded over HTTPS
    document.addEventListener('DOMContentLoaded', function() {
      if (window.location.protocol !== 'https:' && !window.location.hostname.includes('localhost') && !window.location.hostname.includes('127.0.0.1')) {
        alert("Warning: Camera access requires HTTPS. Please use a secure connection for full functionality.");
      }

      // Initialize debug checkbox
      const debugMode = document.getElementById("debug-mode");
      debugMode.addEventListener("change", function() {
        const debugInfo = document.getElementById("debug-info");
        const debugCanvas = document.getElementById("debug-canvas");

        if (this.checked) {
          debugInfo.style.display = "block";
          debugCanvas.style.display = "block";
        } else {
          debugInfo.style.display = "none";
          debugCanvas.style.display = "none";
        }
      });
    });
  </script>
</body>
</html>